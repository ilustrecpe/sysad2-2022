- name: Downloading Prerequisites
  apt:
    pkg:
    - autoconf
    - gcc
    - libc6
    - make
    - wget
    - unzip
    - apache2
    - apache2-utils
    - php
    - libgd-dev
    - libmcrypt-dev
    - libssl-dev
    - bc
    - gawk
    - dc
    - build-essential
    - snmp
    - libnet-snmp-perl
    - gettext
    update_cache: yes

- name: Downloading Source from Nagios repo
  ansible.builtin.get_url:
    url: https://github.com/NagiosEnterprises/nagioscore/archive/nagios-4.4.6.tar.gz
    dest: /tmp/nagioscore-nagios-4.4.6.tar.gz
    mode: '0440'

- name: Unarchiving 
  ansible.builtin.unarchive:
    src: /tmp/nagioscore-nagios-4.4.6.tar.gz
    dest: /tmp/
    remote_src: yes

- name: Configuring Nagios
  ansible.builtin.command: sudo ./configure --with-httpd-conf=/etc/apache2/sites-enabled
  args:
    chdir: /tmp/nagioscore-nagios-4.4.6

- name: Compiling Nagios
  ansible.builtin.command: "{{ item }}"
  args:
    chdir: /tmp/nagioscore-nagios-4.4.6
  with_items:
    - make clean
    - make all
    - make install-groups-users
    - make install
    - make install-daemoninit
    - make install-commandmode
    - make install-config
    - make install-webconf

- name: adding web server to group
  ansible.builtin.user:
    name: www-data
    group: nagios

- name: Installing apache config files
  ansible.builtin.command: "{{ item }}"
  args:
    chdir: /tmp/nagioscore-nagios-4.4.6
  with_items:
    - a2enmod rewrite
    - a2enmod cgi

- name: Downloading Plugin Source
  ansible.builtin.get_url:
    url: https://github.com/nagios-plugins/nagios-plugins/archive/release-2.3.3.tar.gz
    dest: /tmp/nagios-plugins-release-2.3.3.tar.gz
    mode: '0440'

- name: Unarchiving plugins
  ansible.builtin.unarchive:
    src: /tmp/nagios-plugins-release-2.3.3.tar.gz
    dest: /tmp/
    remote_src: yes

- name: Compiling nagios plugins
  ansible.builtin.command: "{{ item }}"
  args:
    chdir: /tmp/nagios-plugins-release-2.3.3
  with_items:
    - ./tools/setup
    - ./configure
    - make
    - make install
